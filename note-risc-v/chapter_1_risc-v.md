### Qemu
> Qemu æ˜¯çº¯è½¯ä»¶å®ç°çš„è™šæ‹ŸåŒ–æ¨¡æ‹Ÿå™¨ï¼Œå‡ ä¹å¯ä»¥æ¨¡æ‹Ÿä»»ä½•ç¡¬ä»¶è®¾å¤‡ï¼Œæˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„å°±æ˜¯èƒ½å¤Ÿæ¨¡æ‹Ÿä¸€å°èƒ½å¤Ÿç‹¬ç«‹è¿è¡Œæ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºè®¤ä¸ºè‡ªå·±å’Œç¡¬ä»¶æ‰“äº¤é“ï¼Œä½†å…¶å®æ˜¯å’Œ Qemu æ¨¡æ‹Ÿå‡ºæ¥çš„ç¡¬ä»¶æ‰“äº¤é“ï¼ŒQemu å°†è¿™äº›æŒ‡ä»¤è½¬è¯‘ç»™çœŸæ­£çš„ç¡¬ä»¶ã€‚

![](imgs/Qemu_struct.png)

##### å‚è€ƒèµ„æ–™ï¼š
https://zhuanlan.zhihu.com/p/72484589

### RISC-V å¸¸è§æŒ‡ä»¤

ç®—æœ¯è¿ç®—

add rd, rs1, rs2

x[rd] = x[rs1] + x[rs2]

æŠŠå¯„å­˜å™¨ x[rs2]åŠ åˆ°å¯„å­˜å™¨ x[rs1]ä¸Šï¼Œç»“æœå†™å…¥ x[rd]ã€‚å¿½ç•¥ç®—æœ¯æº¢å‡ºã€‚

 

addi rd, rs1, immediate

x[rd] = x[rs1] + sext(immediate)

æŠŠç¬¦å·ä½æ‰©å±•çš„ç«‹å³æ•°åŠ åˆ°å¯„å­˜å™¨ x[rs1]ä¸Šï¼Œç»“æœå†™å…¥ x[rd]ã€‚å¿½ç•¥ç®—æœ¯æº¢å‡ºã€‚

 

sub rd, rs1, rs2

x[rd] = x[rs1] âˆ’ x[rs2]

x[rs1]å‡å» x[rs2]ï¼Œç»“æœå†™å…¥ x[rd]ã€‚å¿½ç•¥ç®—æœ¯æº¢å‡ºã€‚

 

div rd, rs1, rs2

x[rd] = x[rs1] Ã·s x[rs2]

ç”¨å¯„å­˜å™¨ x[rs1]çš„å€¼é™¤ä»¥å¯„å­˜å™¨ x[rs2]çš„å€¼ï¼Œå‘é›¶èˆå…¥ï¼Œå°†è¿™äº›æ•°è§†ä¸ºäºŒè¿›åˆ¶è¡¥ç ï¼ŒæŠŠå•†å†™ å…¥ x[rd]ã€‚

 

mul rd, rs1, rs2

x[rd] = x[rs1] Ã— x[rs2]

æŠŠå¯„å­˜å™¨ x[rs2]ä¹˜åˆ°å¯„å­˜å™¨ x[rs1]ä¸Šï¼Œä¹˜ç§¯å†™å…¥ x[rd]ã€‚å¿½ç•¥ç®—æœ¯æº¢å‡ºã€‚

 

rem rd, rs1, rs2

x[rd] = x[rs1] %ğ‘  x[rs2]

æ±‚ä½™æ•°ã€‚x[rs1]é™¤ä»¥ x[rs2]ï¼Œå‘ 0 èˆå…¥ï¼Œéƒ½è§†ä¸º 2 çš„è¡¥ç ï¼Œä½™æ•°å†™å…¥ x[rd]ã€‚

 

neg rd, rs2

x[rd] = âˆ’x[rs2]

æŠŠå¯„å­˜å™¨ x[rs2]çš„äºŒè¿›åˆ¶è¡¥ç å†™å…¥ x[rd]ã€‚

 

é€»è¾‘è¿ç®—

and rd, rs1, rs2

x[rd] = x[rs1] & x[rs2]

å°†å¯„å­˜å™¨ x[rs1]å’Œå¯„å­˜å™¨ x[rs2]ä½ä¸çš„ç»“æœå†™å…¥ x[rd]ã€‚

 

andi  rd, rs1, immediate

x[rd] = x[rs1] & sext(immediate)

æŠŠç¬¦å·ä½æ‰©å±•çš„ç«‹å³æ•°å’Œå¯„å­˜å™¨ x[rs1]ä¸Šçš„å€¼è¿›è¡Œä½ä¸ï¼Œç»“æœå†™å…¥ x[rd]ã€‚

 

or rd, rs1, rs2

x[rd] = ~x[rs1]

æŠŠå¯„å­˜å™¨ x[rs1]å’Œå¯„å­˜å™¨ x[rs2]æŒ‰ä½å–æˆ–ï¼Œç»“æœå†™å…¥ x[rd]ã€‚

 

xor rd, rs1, immediate

x[rd] = x[rs1] ^ sext(immediate)

x[rs1]å’Œæœ‰ç¬¦å·æ‰©å±•çš„ immediate æŒ‰ä½å¼‚æˆ–ï¼Œç»“æœå†™å…¥ x[rd]ã€‚

 

ä½è¿ç®—

sll rd, rs1, rs2

x[rd] = x[rs1] â‰ª x[rs2]

é€»è¾‘å·¦ç§»ï¼ˆç©ºä½è¡¥0ï¼‰

 

slli rd, rs1, shamt

ç«‹å³æ•°é€»è¾‘å·¦ç§»

 

srl rd, rs1, rs2

x[rd] = (x[rs1] â‰«ğ‘¢ x[rs2])

é€»è¾‘å³ç§»ï¼ˆç©ºä½è¡¥0ï¼‰

 

srli rd, rs1, shamt

ç«‹å³æ•°é€»è¾‘å³ç§»

 

sra rd, rs1, rs2

x[rd] = (x[rs1] â‰«ğ‘  x[rs2])

ç®—æœ¯å³ç§»ï¼ˆç©ºä½ç”¨æœ€é«˜ä½å¡«å……ï¼‰

 

srai rd, rs1, shamt

ç«‹å³æ•°é€»è¾‘å³ç§»

 

not td, rs1

x[rd] = ~x[rs1]

æŠŠå¯„å­˜å™¨ x[rs1]å¯¹äº 1 çš„è¡¥ç ï¼ˆå³æŒ‰ä½å–åçš„å€¼ï¼‰å†™å…¥ x[rd]ã€‚å®é™…è¢«æ‰©å±•ä¸º xori rd, rs1, -1ã€‚

 

æ¡ä»¶æ§åˆ¶æŒ‡ä»¤

beq rs1, rs2, offset

if (rs1 == rs2) pc += sext(offset)

è‹¥å¯„å­˜å™¨ x[rs1]å’Œå¯„å­˜å™¨ x[rs2]çš„å€¼ç›¸ç­‰ï¼ŒæŠŠ pc çš„å€¼è®¾ä¸ºå½“å‰å€¼åŠ ä¸Šç¬¦å·ä½æ‰©å±•çš„åç§» offsetã€‚

 

bge rs1, rs2, offset

if (rs1 â‰¥s rs2) pc += sext(offset)

è‹¥å¯„å­˜å™¨ x[rs1]çš„å€¼å¤§äºç­‰äºå¯„å­˜å™¨ x[rs2]çš„å€¼ï¼ˆå‡è§†ä¸ºäºŒè¿›åˆ¶è¡¥ç ï¼‰ï¼ŒæŠŠ pc çš„å€¼è®¾ä¸ºå½“å‰ å€¼åŠ ä¸Šç¬¦å·ä½æ‰©å±•çš„åç§» offsetã€‚

 

blt rs1, rs2, offset

if (rs1 <s rs2) pc += sext(offset)

è‹¥å¯„å­˜å™¨ x[rs1]çš„å€¼å°äºå¯„å­˜å™¨ x[rs2]çš„å€¼ï¼ˆå‡è§†ä¸ºäºŒè¿›åˆ¶è¡¥ç ï¼‰ï¼ŒæŠŠ pc çš„å€¼è®¾ä¸ºå½“å‰å€¼åŠ  ä¸Šç¬¦å·ä½æ‰©å±•çš„åç§» offsetã€‚

 

bne rs1, rs2, offset

if (rs1 â‰  rs2) pc += sext(offset)

è‹¥å¯„å­˜å™¨ x[rs1]å’Œå¯„å­˜å™¨ x[rs2]çš„å€¼ä¸ç›¸ç­‰ï¼ŒæŠŠ pc çš„å€¼è®¾ä¸ºå½“å‰å€¼åŠ ä¸Šç¬¦å·ä½æ‰©å±•çš„åç§» offsetã€‚

 

è·³è½¬æŒ‡ä»¤

j offset

pc += sext(offset)

æŠŠ pc è®¾ç½®ä¸ºå½“å‰å€¼åŠ ä¸Šç¬¦å·ä½æ‰©å±•çš„ offsetï¼Œç­‰åŒäº jal x0, offsetã€‚

 

jal rd, offset

x[rd] = pc+4; pc += sext(offset)

æŠŠä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ (pc+4)ï¼Œç„¶åæŠŠ pc è®¾ç½®ä¸ºå½“å‰å€¼åŠ ä¸Šç¬¦å·ä½æ‰©å±•çš„offsetã€‚rd é»˜è®¤ä¸º x1ã€‚ 

 

jr rs1

pc = x[rs1]

æŠŠ pc è®¾ç½®ä¸º x[rs1]ï¼Œç­‰åŒäº jalr x0, 0(rs1)ã€‚

 

jalr rd, offset(rs1)

t = pc+4; pc =(x[rs1]+sext(offset))&~1; x[rd]= t

æŠŠ pc è®¾ç½®ä¸º x[rs1] + sign-extend(offset)ï¼ŒæŠŠè®¡ç®—å‡ºçš„åœ°å€çš„æœ€ä½æœ‰æ•ˆä½è®¾ä¸º 0ï¼Œå¹¶å°†åŸ pc+4 çš„å€¼å†™å…¥ f[rd]ã€‚rd é»˜è®¤ä¸º x1ã€‚

 

ret 

pc = x[1]

ä»å­è¿‡ç¨‹è¿”å›ã€‚å®é™…è¢«æ‰©å±•ä¸º jalr x0, 0(x1)ã€‚

 

åŠ è½½ä¸å­˜å‚¨æŒ‡ä»¤

la rd, symbol

x[rd] = &symbol

å°† symbol çš„åœ°å€åŠ è½½åˆ° x[rd]ä¸­ã€‚

 

li rd, immediate

x[rd] = immediate

å°†å¸¸é‡åŠ è½½åˆ° x[rd]ä¸­ã€‚

 

lw rd, offset(rs1)

x[rd] = sext(M[x[rs1] + sext(offset)][31:0])

ä»åœ°å€ x[rs1] + sign-extend(offset)è¯»å–å››ä¸ªå­—èŠ‚ï¼Œå†™å…¥ x[rd]ã€‚

 

sw rs2, offset(rs1)

M[x[rs1] + sext(offset) = x[rs2][31: 0]

å°† x[rs2]çš„ä½ä½ 4 ä¸ªå­—èŠ‚å­˜å…¥å†…å­˜åœ°å€ x[rs1]+sign-extend(offset)ã€‚

æ‘˜è‡ª[åšå®¢å›­](https://www.cnblogs.com/truelycloud/p/10807398.html)